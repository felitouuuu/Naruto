// carnaval/carnaval.js
// Escucha embeds en un canal espec√≠fico y, si detecta "Luna de Sangre",
// hace ping + embed decorado y recordatorio.
// Adem√°s, incluye el comando de prueba !carnaval.
// Uso: require('./carnaval/carnaval')(client);

const { MessageEmbed } = require('discord.js');

const TARGET_CHANNEL = '1390187635888095346';
const PING_USER_ID = '1003512479277662208'; // @felitou
const TRIGGER_KEYWORDS = ['luna de sangre', 'sangre', 'luna'];
const TRIGGERS = new Set(['!carnaval']); // comando de test

module.exports = (client) => {
  const processed = new Set();

  client.on('message', async (msg) => {
    try {
      if (!msg) return;

      // --- üîπ Comando de prueba !carnaval ---
      if (msg.content) {
        const content = msg.content.trim().toLowerCase();
        if (TRIGGERS.has(content) && !(msg.author && msg.author.bot)) {
          const embed = new MessageEmbed()
            .setTitle('üé™ Test: Comando Carnaval')
            .setDescription('Comando de prueba activado correctamente.')
            .addField('Uso', '`!carnaval` ‚Äî Env√≠a este embed de test', false)
            .addField('Nota', 'Este comando prueba que el m√≥dulo Carnaval est√° funcionando.', false)
            .setColor('#FF6F61')
            .setFooter('M√≥dulo Carnaval')
            .setTimestamp();

          await msg.channel.send(embed).catch(() => {});
          try { await msg.react('üéâ'); } catch (e) {}
          return;
        }
      }

      // --- üîπ Watcher de Luna de Sangre ---
      if (!msg.channel || msg.channel.id !== TARGET_CHANNEL) return;
      if (processed.has(msg.id)) return;
      if (msg.author && msg.author.id === client.user.id) return;
      if (!msg.embeds || msg.embeds.length === 0) return;

      const found = msg.embeds.some(e => {
        const title = (e.title || '').toLowerCase();
        const desc = (e.description || '').toLowerCase();
        const fields = (e.fields || []).map(f => (f.name + ' ' + f.value).toLowerCase()).join(' ');
        return TRIGGER_KEYWORDS.some(k => title.includes(k) || desc.includes(k) || fields.includes(k));
      });

      if (!found) return;
      processed.add(msg.id);

      const mention = `<@${PING_USER_ID}>`;

      const embed = new MessageEmbed()
        .setTitle('üåë El clima de Luna de Sangre :drop_of_blood: est√° activo')
        .setDescription('*La luna carmes√≠ ilumina la noche. Todo parece inquieto bajo su influjo oscuro.*')
        .addField('‚è±Ô∏è Tiempo', '1 hora (recordatorio programado)', true)
        .addField('üöÄ Mejora', 'El clima est√° en favor de la actividad **undefined**.\nLa probabilidad de obtener items raros es mayor.', false)
        .addField('üé™ Carnaval', 'Ven a aprovechar el comando `!pet adventure` para obtener grandiosas cosas en el carnaval.', false)
        .setColor('#8B0000')
        .setFooter('Evento temporal ‚Äî disfruta mientras dure')
        .setTimestamp()
        .setThumbnail('https://i.imgur.com/3V6H3bM.png');

      await msg.channel.send(mention).catch(() => {});
      await msg.channel.send(embed).catch(() => {});

      setTimeout(async () => {
        try {
          const remindEmbed = new MessageEmbed()
            .setTitle('‚è≤Ô∏è Recordatorio: Luna de Sangre (1h)')
            .setDescription('Ha pasado 1 hora desde que se activ√≥ la Luna de Sangre. Revisa el carnaval y aprovecha los √∫ltimos minutos.')
            .addField('Comando recomendado', '`!pet adventure`', true)
            .setColor('#550000')
            .setTimestamp();

          await msg.channel.send(`<@${PING_USER_ID}>`).catch(() => {});
          await msg.channel.send(remindEmbed).catch(() => {});
        } catch (e) {}
      }, 60 * 60 * 1000);

    } catch (err) {
      // silencioso
    }
  });
};